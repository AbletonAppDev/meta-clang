From fded84c3b6db127a0520b8216a82fe6c4b400247 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Dominic=20Sacr=C3=A9?= <dominic.sacre@gmx.de>
Date: Tue, 14 Jun 2016 09:50:21 +0200
Subject: [PATCH] ARMTargetLowering: Handle MUSLEABI to fix AEABI helper
 calling convention
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

AEABI floating point helper functions always use AAPCS (soft-float)
calling convention. Recognize MUSLEABI targets to fix the code generated
for musl-based hard-float builds.

Signed-off-by: Dominic Sacr√© <dominic.sacre@gmx.de>
---
 lib/Target/ARM/ARMISelLowering.cpp | 2 +-
 lib/Target/ARM/ARMSubtarget.h      | 5 +++++
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/lib/Target/ARM/ARMISelLowering.cpp b/lib/Target/ARM/ARMISelLowering.cpp
index a2daa89..f4ed6f3 100644
--- a/lib/Target/ARM/ARMISelLowering.cpp
+++ b/lib/Target/ARM/ARMISelLowering.cpp
@@ -254,7 +254,7 @@ ARMTargetLowering::ARMTargetLowering(const TargetMachine &TM,
   // RTLIB
   if (Subtarget->isAAPCS_ABI() &&
       (Subtarget->isTargetAEABI() || Subtarget->isTargetGNUAEABI() ||
-       Subtarget->isTargetAndroid())) {
+       Subtarget->isTargetAndroid() || Subtarget->isTargetMUSLEABI())) {
     static const struct {
       const RTLIB::Libcall Op;
       const char * const Name;
diff --git a/lib/Target/ARM/ARMSubtarget.h b/lib/Target/ARM/ARMSubtarget.h
index 4d54e57..3ba330b 100644
--- a/lib/Target/ARM/ARMSubtarget.h
+++ b/lib/Target/ARM/ARMSubtarget.h
@@ -399,6 +399,11 @@ public:
             TargetTriple.getEnvironment() == Triple::GNUEABIHF) &&
            !isTargetDarwin() && !isTargetWindows();
   }
+  bool isTargetMUSLEABI() const {
+    return (TargetTriple.getEnvironment() == Triple::MUSLEABI ||
+            TargetTriple.getEnvironment() == Triple::MUSLEABIHF) &&
+           !isTargetDarwin() && !isTargetWindows();
+  }
 
   // ARM Targets that support EHABI exception handling standard
   // Darwin uses SjLj. Other targets might need more checks.
-- 
2.8.4

